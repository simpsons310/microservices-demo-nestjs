# ğŸš€ Microservices E-commerce Demo

## ğŸ“‹ MÃ” Táº¢ PROJECT

### Tá»•ng quan

ÄÃ¢y lÃ  má»™t demo project vá» **Microservices Architecture** Ä‘Æ°á»£c xÃ¢y dá»±ng báº±ng **NestJS** vÃ  **TypeScript**. Project mÃ´ phá»ng má»™t há»‡ thá»‘ng e-commerce Ä‘Æ¡n giáº£n vá»›i cÃ¡c chá»©c nÄƒng cÆ¡ báº£n: quáº£n lÃ½ ngÆ°á»i dÃ¹ng, sáº£n pháº©m, vÃ  Ä‘Æ¡n hÃ ng.

### Kiáº¿n trÃºc tá»•ng quan

```text
Client/Browser
       â†“
API Gateway (Port 3000)
  [Authentication & Routing]
       â†“
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“        â†“          â†“          â†“
User     Product    Order     [HTTP REST]
Service  Service   Service
(3001)   (3002)    (3003)
   â†“        â†“          â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         PostgreSQL
    (Multiple Schemas)
```

---

## ğŸ› ï¸ TECH STACK

```text
| Component | Technology |
|-----------|-----------|
| Framework | NestJS (TypeScript) |
| Database | PostgreSQL |
| Cache | Redis |
| ORM | TypeORM |
| Authentication | JWT |
| Containerization | Docker & Docker Compose |
| API Communication | HTTP/REST |
```

---

## ğŸ—ï¸ SERVICES

### 1. API Gateway (Port 3000)

**Chá»©c nÄƒng:**

- Entry point duy nháº¥t cho táº¥t cáº£ requests tá»« client
- JWT authentication vÃ  authorization
- Routing requests Ä‘áº¿n cÃ¡c microservices
- Global error handling
- Request logging

**Endpoints:**

- `/api/auth/*` â†’ User Service
- `/api/users/*` â†’ User Service
- `/api/products/*` â†’ Product Service
- `/api/orders/*` â†’ Order Service

### 2. User Service (Port 3001)

**Chá»©c nÄƒng:**

- Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
- Authentication (Login/Register)
- JWT token generation
- User profile management

**Database:** PostgreSQL schema `user_schema`

**API Endpoints:**

- `POST /auth/register` - ÄÄƒng kÃ½ tÃ i khoáº£n má»›i
- `POST /auth/login` - ÄÄƒng nháº­p
- `GET /users/me` - Láº¥y thÃ´ng tin profile (cáº§n JWT)

### 3. Product Service (Port 3002)

**Chá»©c nÄƒng:**

- CRUD sáº£n pháº©m
- Quáº£n lÃ½ inventory/stock
- Cung cáº¥p API cho Order Service check stock

**Database:** PostgreSQL schema `product_schema`

**API Endpoints:**

- `GET /products` - Láº¥y danh sÃ¡ch sáº£n pháº©m (cÃ³ pagination)
- `GET /products/:id` - Láº¥y chi tiáº¿t sáº£n pháº©m
- `POST /products` - Táº¡o sáº£n pháº©m má»›i (admin)
- `PUT /products/:id` - Cáº­p nháº­t sáº£n pháº©m (admin)
- `DELETE /products/:id` - XÃ³a sáº£n pháº©m (admin)
- `POST /products/:id/reduce-stock` - Giáº£m stock (internal API)

### 4. Order Service (Port 3003)

**Chá»©c nÄƒng:**

- Táº¡o Ä‘Æ¡n hÃ ng
- Quáº£n lÃ½ Ä‘Æ¡n hÃ ng
- Gá»i Product Service Ä‘á»ƒ check vÃ  giáº£m stock

**Database:** PostgreSQL schema `order_schema`

**API Endpoints:**

- `POST /orders` - Táº¡o Ä‘Æ¡n hÃ ng má»›i (cáº§n JWT)
- `GET /orders` - Láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng cá»§a user (cáº§n JWT)
- `GET /orders/:id` - Láº¥y chi tiáº¿t Ä‘Æ¡n hÃ ng (cáº§n JWT)

---

## ğŸ’¾ DATABASE DESIGN

### PostgreSQL Database: `ecommerce_db`

#### Schema: `user_schema`

```sql
Table: users
- id: UUID (Primary Key)
- email: VARCHAR (Unique)
- password: VARCHAR (Hashed)
- name: VARCHAR
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### Schema: `product_schema`

```sql
Table: products
- id: UUID (Primary Key)
- name: VARCHAR
- description: TEXT
- price: DECIMAL
- stock: INTEGER
- image_url: VARCHAR
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### Schema: `order_schema`

```sql
Table: orders
- id: UUID (Primary Key)
- user_id: UUID
- total_amount: DECIMAL
- status: ENUM (pending, confirmed, cancelled)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP

Table: order_items
- id: UUID (Primary Key)
- order_id: UUID (Foreign Key)
- product_id: UUID
- product_name: VARCHAR
- quantity: INTEGER
- price: DECIMAL
```

---

## ğŸ” AUTHENTICATION FLOW

```text
1. User Ä‘Äƒng kÃ½/Ä‘Äƒng nháº­p
   â†“
2. User Service verify credentials
   â†“
3. Generate JWT token
   â†“
4. Client lÆ°u token
   â†“
5. Má»i request sau Ä‘á»u gá»­i kÃ¨m token trong header:
   Authorization: Bearer <token>
   â†“
6. API Gateway verify token
   â†“
7. Forward request Ä‘áº¿n service tÆ°Æ¡ng á»©ng
```

---

## ğŸ“Š DATA FLOW: Táº O ÄÆ N HÃ€NG

```text
1. Client â†’ API Gateway: POST /api/orders
   Headers: { Authorization: Bearer <JWT> }
   Body: {
     items: [
       { productId: "...", quantity: 2 }
     ]
   }

2. API Gateway:
   - Verify JWT token
   - Extract user info
   - Forward to Order Service

3. Order Service:
   - Nháº­n request vá»›i user info
   - Loop qua tá»«ng product:
     â†’ Gá»i Product Service: GET /products/:id
     â†’ Check stock availability
   
4. Product Service:
   - Return product info vÃ  stock

5. Order Service:
   - Náº¿u stock Ä‘á»§:
     â†’ Calculate total amount
     â†’ Create order trong database
     â†’ Gá»i Product Service Ä‘á»ƒ reduce stock
     â†’ Return success
   - Náº¿u stock khÃ´ng Ä‘á»§:
     â†’ Return error

6. API Gateway â†’ Client: Return response
```

---

## ğŸš€ HÆ¯á»šNG DáºªN CHáº Y PROJECT

### YÃªu cáº§u há»‡ thá»‘ng

- Node.js >= 18.x
- Docker & Docker Compose
- Git

### BÆ°á»›c 1: Clone project

```bash
# Clone repository (giáº£ sá»­ báº¡n Ä‘Ã£ cÃ³ code)
git clone <repository-url>
cd microservices-ecommerce
```

### BÆ°á»›c 2: Cáº¥u trÃºc thÆ° má»¥c

```text
microservices-ecommerce/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env.example
â”œâ”€â”€ api-gateway/
â”œâ”€â”€ user-service/
â”œâ”€â”€ product-service/
â””â”€â”€ order-service/
```

### BÆ°á»›c 3: Setup environment variables

```bash
# Copy file .env.example thÃ nh .env
cp .env.example .env

# Ná»™i dung file .env
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres123
DATABASE_NAME=ecommerce_db

REDIS_HOST=redis
REDIS_PORT=6379

JWT_SECRET=your-super-secret-jwt-key-change-this
JWT_EXPIRES_IN=1d

USER_SERVICE_URL=http://user-service:3001
PRODUCT_SERVICE_URL=http://product-service:3002
ORDER_SERVICE_URL=http://order-service:3003
```

### BÆ°á»›c 4: Cháº¡y vá»›i Docker Compose

```bash
# Build vÃ  start táº¥t cáº£ services
docker-compose up --build

# Hoáº·c cháº¡y á»Ÿ background
docker-compose up -d --build

# Xem logs
docker-compose logs -f

# Stop services
docker-compose down

# Stop vÃ  xÃ³a volumes (database data)
docker-compose down -v
```

### BÆ°á»›c 5: Kiá»ƒm tra services

Sau khi cháº¡y thÃ nh cÃ´ng, cÃ¡c services sáº½ available táº¡i:

- **API Gateway**: http://localhost:3000
- **User Service**: http://localhost:3001
- **Product Service**: http://localhost:3002
- **Order Service**: http://localhost:3003
- **PostgreSQL**: localhost:5432
- **Redis**: localhost:6379

### BÆ°á»›c 6: Test API

#### 1. ÄÄƒng kÃ½ user má»›i

```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123",
    "name": "Test User"
  }'
```

#### 2. Login

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'

# Response sáº½ tráº£ vá»:
# {
#   "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
# }
```

#### 3. Táº¡o sáº£n pháº©m (cáº§n token)

```bash
curl -X POST http://localhost:3000/api/products \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "name": "MacBook Pro",
    "description": "Apple MacBook Pro 16 inch",
    "price": 2499.99,
    "stock": 10,
    "imageUrl": "https://example.com/macbook.jpg"
  }'
```

#### 4. Láº¥y danh sÃ¡ch sáº£n pháº©m

```bash
curl http://localhost:3000/api/products
```

#### 5. Táº¡o Ä‘Æ¡n hÃ ng (cáº§n token)

```bash
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "items": [
      {
        "productId": "product-uuid-here",
        "quantity": 2
      }
    ]
  }'
```

#### 6. Xem Ä‘Æ¡n hÃ ng cá»§a mÃ¬nh (cáº§n token)

```bash
curl http://localhost:3000/api/orders \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## ğŸ”§ DEVELOPMENT MODE

Náº¿u muá»‘n cháº¡y tá»«ng service riÃªng láº» Ä‘á»ƒ development:

### 1. Start PostgreSQL vÃ  Redis

```bash
docker-compose up postgres redis -d
```

### 2. Install dependencies cho tá»«ng service

```bash
cd user-service && npm install
cd ../product-service && npm install
cd ../order-service && npm install
cd ../api-gateway && npm install
```

### 3. Cháº¡y tá»«ng service

```bash
# Terminal 1: User Service
cd user-service
npm run start:dev

# Terminal 2: Product Service
cd product-service
npm run start:dev

# Terminal 3: Order Service
cd order-service
npm run start:dev

# Terminal 4: API Gateway
cd api-gateway
npm run start:dev
```

---

## ğŸ“ API DOCUMENTATION

### Authentication

- **Register**

```http
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123",
  "name": "John Doe"
}

Response: 201 Created
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "John Doe"
}
```

- **Login**

```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}

Response: 200 OK
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Products

- **Get All Products**

```http
GET /api/products?page=1&limit=10

Response: 200 OK
{
  "data": [
    {
      "id": "uuid",
      "name": "Product Name",
      "description": "Description",
      "price": 99.99,
      "stock": 50
    }
  ],
  "total": 100,
  "page": 1,
  "limit": 10
}
```

- **Create Product** (Requires Auth)

```http
POST /api/products
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "MacBook Pro",
  "description": "Apple MacBook Pro 16 inch",
  "price": 2499.99,
  "stock": 10,
  "imageUrl": "https://example.com/image.jpg"
}

Response: 201 Created
```

### Orders

**Create Order** (Requires Auth)

```http
POST /api/orders
Authorization: Bearer <token>
Content-Type: application/json

{
  "items": [
    {
      "productId": "uuid",
      "quantity": 2
    }
  ]
}

Response: 201 Created
{
  "id": "uuid",
  "userId": "uuid",
  "totalAmount": 199.98,
  "status": "pending",
  "items": [...]
}
```

**Get My Orders** (Requires Auth)

```http
GET /api/orders
Authorization: Bearer <token>

Response: 200 OK
[
  {
    "id": "uuid",
    "totalAmount": 199.98,
    "status": "pending",
    "createdAt": "2024-01-01T00:00:00Z"
  }
]
```

---

## ğŸ› TROUBLESHOOTING

### Port Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng

```bash
# Check port Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng
lsof -i :3000  # hoáº·c port khÃ¡c

# Kill process
kill -9 <PID>
```

### Database connection error

```bash
# Restart PostgreSQL container
docker-compose restart postgres

# Check logs
docker-compose logs postgres
```

### Service khÃ´ng start

```bash
# Rebuild containers
docker-compose down
docker-compose up --build

# Check logs cá»§a service cá»¥ thá»ƒ
docker-compose logs user-service
```

---

## ğŸ“š Há»ŒC THÃŠM

### Design Patterns trong project

1. **API Gateway Pattern** - Single entry point
2. **Database per Schema** - Data isolation
3. **Service-to-Service Communication** - HTTP REST
4. **JWT Authentication** - Stateless auth

### Microservices Best Practices

- âœ… Loose coupling giá»¯a cÃ¡c services
- âœ… Single responsibility per service
- âœ… Independent deployment
- âœ… Decentralized data management
- âœ… Failure isolation

### Next Steps Ä‘á»ƒ má»Ÿ rá»™ng

- [ ] ThÃªm Swagger/OpenAPI documentation
- [ ] Implement logging vá»›i Winston
- [ ] ThÃªm monitoring (Prometheus + Grafana)
- [ ] Circuit breaker pattern
- [ ] API rate limiting
- [ ] Unit tests & E2E tests
- [ ] Message queue (RabbitMQ/Kafka) cho async tasks

---

## ğŸ“ SUPPORT

Náº¿u cÃ³ váº¥n Ä‘á» gÃ¬, báº¡n cÃ³ thá»ƒ:

1. Check logs: `docker-compose logs -f`
2. Verify environment variables trong `.env`
3. Ensure Docker vÃ  Docker Compose Ä‘ang cháº¡y
4. Check port conflicts

---

## ğŸ“„ LICENSE

MIT License - Free to use for learning purposes

---

- **Happy Learning Microservices! ğŸ‰**
